<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.itheima.health.dao.RoleDao">

    <resultMap id="roleMap" type="role">
        <id column="id" property="id"></id>
        <collection property="permissions" column="id" select="com.itheima.health.dao.PermissionDao.findPermissionsByRoleId"></collection>
    </resultMap>
    <!--使用用户id，查询角色的集合（联合查询）-->
    <select id="findRolesByUserId" parameterType="int" resultMap="roleMap">
        SELECT r.* FROM t_role r,t_user_role up WHERE r.id = up.role_id AND up.user_id = #{userId}
    </select>

    <!--查询所有的角色信息-->
    <select id="findAllRoles" resultType="role">
        select * from t_role
    </select>

    <!--获取当前角色列表数据:-->
    <select id="findPageByQueryString" parameterType="string" resultType="role">
        select * from t_role
        <if test="value != null and value.length > 0">
            where name like "%"#{value}"%" or keyword like "%"#{value}"%" or description like "%"#{value}"%"
        </if>
    </select>

    <!-- 添加角色基本信息-->
    <insert id="addRoleDetailMessage" parameterType="role">
        <selectKey resultType="int" keyColumn="id" keyProperty="id" order="AFTER">
            select last_insert_id()
        </selectKey>
        insert into t_role (name, keyword, description) values (#{name},#{keyword},#{description});
    </insert>

    <!--添加角色关联权限信息:-->
    <insert id="addRoleReferencePermission">
        insert into t_role_permission (role_id, permission_id) values (#{roleId},#{permissionId});
    </insert>

    <!--添加角色关联菜单信息:-->
    <insert id="addRoleReferenceMenu">
        insert into t_role_menu (role_id, menu_id) values (#{roleId},#{menuId});
    </insert>

    <!--根据role查询role信息-->
    <select id="findRoleById" parameterType="int" resultType="role">
        select * from t_role where id = #{roleId}
    </select>

    <!--查询角色关联的权限信息id-->
    <select id="findReferencePermissionIds" parameterType="int" resultType="int">
        select permission_id from t_role_permission where role_id = #{roleId}
    </select>

    <!--查询角色关联的菜单信息id-->
    <select id="findReferenceMenuIds" parameterType="int" resultType="int">
        select menu_id from t_role_menu where role_id = #{roleId}
    </select>

    <!--更新角色信息:-->
    <update id="updateRoleDetailMessage" parameterType="role">
        update t_role set  name = #{name},keyword = #{keyword},description = #{description} where id = #{id}
    </update>

    <!--删除角色关联的权限信息:-->
    <delete id="deleteRoleReferencePermissionIds" parameterType="int">
        delete from t_role_permission where role_id = #{roleId}
    </delete>

    <!--删除角色关联的菜单信息:-->
    <delete id="deleteRoleReferenceMenuIds" parameterType="int">
        delete from t_role_menu where role_id = #{roleId}
    </delete>

    <!--删除角色基本信息:-->
    <delete id="deleteRoleDetailMessage" parameterType="int">
        delete from t_role where id = #{id}
    </delete>
</mapper>

