<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.itheima.health.dao.MemberDao">

    <!--根据手机号查询会员-->
    <select id="findMemberByTelephone" parameterType="string" resultType="member">
        SELECT * FROM t_member WHERE phoneNumber = #{telephone}
    </select>

    <!--新增-->
    <insert id="add" parameterType="member">
        <selectKey keyColumn="id" keyProperty="id" resultType="int" order="AFTER">
            select last_insert_id();
        </selectKey>
        insert into t_member(fileNumber,name,sex,idCard,phoneNumber,regTime,password,email,birthday,remark) values (#{fileNumber},#{name},#{sex},#{idCard},#{phoneNumber},#{regTime},#{password},#{email},#{birthday},#{remark})
    </insert>

    <!--查询按照日期查询在该日期之前的会员数量-->
    <select id="findCountByDate" parameterType="string" resultType="int">
        SELECT COUNT(id) FROM t_member WHERE regTime &lt;= #{date}
    </select>

    <!--根据当前时间，统计当前时间注册的会员-->
    <select id="findMemberCountByDate" parameterType="string" resultType="int">
        SELECT COUNT(id) FROM t_member WHERE regTime = #{date}
    </select>

    <!--查询总会员数-->
    <select id="findMemberTotalCount" resultType="int">
        SELECT COUNT(id) FROM t_member
    </select>

    <!--根据当前时间，统计当前时间之后注册的会员数量-->
    <select id="findMemberCountAfterDate" parameterType="string" resultType="int">
        SELECT COUNT(id) FROM t_member WHERE regTime &gt;= #{date}
    </select>

    <select id="getMemberSexReport" resultType="map">
         select case when sex = 1 then '男' when sex = 2 then '女' else '未知' end name,count(*) as value from t_member group by sex
    </select>

    <select id="getMemberAgeReport" resultType="map">
        SELECT '[0-18)' name, COUNT(*) value
        FROM (select *,(YEAR(CURDATE())-YEAR(birthday))as age from t_member ) newMember
        WHERE age BETWEEN 0 AND 17
        UNION ALL

        SELECT '[18-30)' name, COUNT(*)  value
        FROM (select *,(YEAR(CURDATE())-YEAR(birthday))as age from t_member ) newMember
        WHERE age BETWEEN 18 AND 29
        UNION ALL

        SELECT '[30-45)' name, COUNT(*)  value
        FROM (select *,(YEAR(CURDATE())-YEAR(birthday))as age from t_member ) newMember
        WHERE age BETWEEN 30 AND 44
        UNION ALL

        SELECT '[45以上' name, COUNT(*)  value
        FROM (select *,(YEAR(CURDATE())-YEAR(birthday))as age from t_member ) newMember
        WHERE age > 45
    </select>
    <select id="findPage" parameterType="string" resultType="member">
        select * from t_member
        <if test="value!=null and value.length>0">
            where fileNumber = #{value} or name = #{value} or phoneNumber = #{value}
        </if>
    </select>
    <!--使用主键ID，查询检查项对象-->
    <select id="findById" parameterType="int" resultType="member">
        select * from t_member where id = #{id}
    </select>
    <!--更新会员信息-->
    <update id="edit" parameterType="member">
        update t_member
        <set>
            <if test="fileNumber!=null">
                fileNumber=#{fileNumber},
            </if>
            <if test="name!=null">
                name=#{name},
            </if>
            <if test="sex!=null">
                sex=#{sex},
            </if>

            <if test="idCard!=null">
                idCard=#{idCard},
            </if>
            <if test="phoneNumber!=null">
                phoneNumber=#{phoneNumber},
            </if>
            <if test="regTime!=null">
                regTime=#{regTime},
            </if>
            <if test="password!=null">
                password=#{password},
            </if>
            <if test="email!=null">
                email=#{email},
            </if>
            <if test="birthday!=null">
                birthday=#{birthday},
            </if>
            <if test="remark!=null">
                remark=#{remark},
            </if>
        </set>
        where id=#{id}
    </update>
    <!--删除会员-->
    <delete id="deleteById" parameterType="int">
        delete from t_member where id = #{id}
    </delete>
    <select id="findCountByMemberId" parameterType="int" resultType="long">
        SELECT COUNT(*) FROM t_order WHERE member_id = #{id}
    </select>
</mapper>